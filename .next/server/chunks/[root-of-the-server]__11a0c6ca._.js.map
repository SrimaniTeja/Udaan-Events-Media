{"version":3,"sources":["../../../lib/db/store.ts","../../../lib/db/prisma.ts","../../../lib/workflow.ts","../../../lib/db/mappers.ts"],"sourcesContent":["import \"server-only\";\r\n\r\nimport type { Event, EventStatus, FileType, MediaFile, SessionUser, User, UserRole } from \"@/lib/types\";\r\nimport type { Notification, NotificationType } from \"@/lib/notifications\";\r\nimport { prisma } from \"@/lib/db/prisma\";\r\nimport { canTransition } from \"@/lib/workflow\";\r\nimport { mapEvent, mapFile, mapNotification, mapSessionUser, mapUser } from \"@/lib/db/mappers\";\r\n\r\nexport async function listUsers(role?: UserRole): Promise<User[]> {\r\n  const users = await prisma.user.findMany({\r\n    where: role ? { role } : undefined,\r\n    orderBy: { createdAt: \"asc\" },\r\n  });\r\n  return users.map(mapUser);\r\n}\r\n\r\nexport async function findUserByEmail(email: string): Promise<User | null> {\r\n  const user = await prisma.user.findUnique({ where: { email: email.toLowerCase() } });\r\n  return user ? mapUser(user) : null;\r\n}\r\n\r\nexport async function getDbUserByEmail(email: string) {\r\n  return prisma.user.findUnique({ where: { email: email.toLowerCase() } });\r\n}\r\n\r\nexport async function listEventsForUser(user: SessionUser): Promise<Event[]> {\r\n  const where =\r\n    user.role === \"ADMIN\"\r\n      ? {}\r\n      : user.role === \"CAMERAMAN\"\r\n        ? { cameramanId: user.id }\r\n        : { editorId: user.id };\r\n\r\n  const events = await prisma.event.findMany({ where, orderBy: { date: \"desc\" } });\r\n  return events.map(mapEvent);\r\n}\r\n\r\nexport async function getEventById(eventId: string): Promise<Event | null> {\r\n  const event = await prisma.event.findUnique({ where: { id: eventId } });\r\n  return event ? mapEvent(event) : null;\r\n}\r\n\r\nexport async function listFilesForEvent(eventId: string, fileType?: FileType): Promise<MediaFile[]> {\r\n  const files = await prisma.file.findMany({\r\n    where: { eventId, ...(fileType ? { fileType } : {}) },\r\n    orderBy: { createdAt: \"desc\" },\r\n  });\r\n  return files.map(mapFile);\r\n}\r\n\r\nexport async function getFileById(fileId: string): Promise<MediaFile | null> {\r\n  const f = await prisma.file.findUnique({ where: { id: fileId } });\r\n  return f ? mapFile(f) : null;\r\n}\r\n\r\nexport async function createEvent(input: {\r\n  name: string;\r\n  date: string;\r\n  cameramanId: string;\r\n  editorId: string | null;\r\n}): Promise<Event> {\r\n  const event = await prisma.event.create({\r\n    data: {\r\n      name: input.name,\r\n      date: new Date(input.date),\r\n      cameramanId: input.cameramanId,\r\n      editorId: input.editorId ?? null,\r\n      status: \"CREATED\",\r\n    },\r\n  });\r\n  return mapEvent(event);\r\n}\r\n\r\nexport async function transitionEvent(eventId: string, nextStatus: EventStatus): Promise<Event | null> {\r\n  return prisma.$transaction(async (tx: any) => {\r\n    const event = await tx.event.findUnique({ where: { id: eventId } });\r\n    if (!event) return null;\r\n\r\n    if (!canTransition(event.status as any, nextStatus)) {\r\n      throw new Error(`Invalid status transition: ${event.status} -> ${nextStatus}`);\r\n    }\r\n\r\n    const updated = await tx.event.update({\r\n      where: { id: eventId },\r\n      data: { status: nextStatus },\r\n    });\r\n    return mapEvent(updated);\r\n  });\r\n}\r\n\r\nexport async function setEditorFree(editorId: string, isFree: boolean): Promise<User> {\r\n  const u = await prisma.user.update({\r\n    where: { id: editorId },\r\n    data: { isFree },\r\n  });\r\n  return mapUser(u);\r\n}\r\n\r\nexport async function setEditor(eventId: string, editorId: string | null): Promise<Event> {\r\n  const event = await prisma.event.update({\r\n    where: { id: eventId },\r\n    data: { editorId },\r\n  });\r\n  return mapEvent(event);\r\n}\r\n\r\nexport async function autoAssignFreeEditor(eventId: string): Promise<Event | null> {\r\n  return prisma.$transaction(async (tx: any) => {\r\n    const event = await tx.event.findUnique({ where: { id: eventId } });\r\n    if (!event) return null;\r\n    if (event.editorId) return mapEvent(event);\r\n\r\n    const freeEditor = await tx.user.findFirst({\r\n      where: { role: \"EDITOR\", isFree: true },\r\n      orderBy: { createdAt: \"asc\" },\r\n    });\r\n    if (!freeEditor) return mapEvent(event);\r\n\r\n    await tx.user.update({ where: { id: freeEditor.id }, data: { isFree: false } });\r\n    const updated = await tx.event.update({\r\n      where: { id: eventId },\r\n      data: { editorId: freeEditor.id },\r\n    });\r\n    return mapEvent(updated);\r\n  });\r\n}\r\n\r\nexport async function addFile(params: {\r\n  eventId: string;\r\n  uploadedBy: string;\r\n  fileType: FileType;\r\n  name: string;\r\n  size: number;\r\n}): Promise<MediaFile> {\r\n  const f = await prisma.file.create({\r\n    data: {\r\n      eventId: params.eventId,\r\n      uploaderId: params.uploadedBy,\r\n      fileType: params.fileType,\r\n      name: params.name,\r\n      size: params.size,\r\n      driveFileId: null,\r\n    },\r\n  });\r\n  return mapFile(f);\r\n}\r\n\r\nexport async function createNotification(params: {\r\n  userId: string;\r\n  title: string;\r\n  message: string;\r\n  type: NotificationType;\r\n  eventId?: string;\r\n}): Promise<Notification> {\r\n  const n = await prisma.notification.create({\r\n    data: {\r\n      userId: params.userId,\r\n      eventId: params.eventId,\r\n      title: params.title,\r\n      message: params.message,\r\n      type: params.type,\r\n    },\r\n  });\r\n  return mapNotification(n);\r\n}\r\n\r\nexport async function listNotificationsForUser(userId: string): Promise<Notification[]> {\r\n  const notifications = await prisma.notification.findMany({\r\n    where: { userId },\r\n    orderBy: { createdAt: \"desc\" },\r\n  });\r\n  return notifications.map(mapNotification);\r\n}\r\n\r\nexport async function markNotificationRead(notificationId: string, userId: string): Promise<Notification | null> {\r\n  const existing = await prisma.notification.findUnique({ where: { id: notificationId } });\r\n  if (!existing || existing.userId !== userId) return null;\r\n\r\n  const updated = await prisma.notification.update({\r\n    where: { id: notificationId },\r\n    data: { isRead: true },\r\n  });\r\n  return mapNotification(updated);\r\n}\r\n\r\nexport async function getSessionUserFromDb(userId: string) {\r\n  const u = await prisma.user.findUnique({ where: { id: userId } });\r\n  return u ? mapSessionUser(u) : null;\r\n}\r\n\r\n\r\n","import \"server-only\";\r\n\r\nimport { PrismaClient } from \"@prisma/client\";\r\n\r\nconst globalForPrisma = globalThis as unknown as { prisma?: PrismaClient };\r\n\r\nexport const prisma =\r\n  globalForPrisma.prisma ??\r\n  new PrismaClient({\r\n    log: process.env.NODE_ENV === \"development\" ? [\"warn\", \"error\"] : [\"error\"],\r\n  });\r\n\r\nif (process.env.NODE_ENV !== \"production\") globalForPrisma.prisma = prisma;\r\n\r\n\r\n","import type { EventStatus, FileType, UserRole } from \"@/lib/types\";\r\n\r\nexport const EVENT_STATUSES: EventStatus[] = [\r\n  \"CREATED\",\r\n  \"RAW_UPLOADED\",\r\n  \"ASSIGNED\",\r\n  \"EDITING\",\r\n  \"FINAL_UPLOADED\",\r\n  \"COMPLETED\",\r\n];\r\n\r\nexport function canTransition(from: EventStatus, to: EventStatus) {\r\n  const allowed: Record<EventStatus, EventStatus[]> = {\r\n    CREATED: [\"RAW_UPLOADED\"],\r\n    RAW_UPLOADED: [\"ASSIGNED\"],\r\n    ASSIGNED: [\"EDITING\"],\r\n    EDITING: [\"FINAL_UPLOADED\"],\r\n    FINAL_UPLOADED: [\"COMPLETED\"],\r\n    COMPLETED: [],\r\n  };\r\n  return allowed[from].includes(to);\r\n}\r\n\r\nexport function canUploadFile(params: {\r\n  role: UserRole;\r\n  fileType: FileType;\r\n  status: EventStatus;\r\n}) {\r\n  const { role, fileType, status } = params;\r\n\r\n  if (role === \"CAMERAMAN\" && fileType === \"RAW\") return status === \"CREATED\";\r\n  if (role === \"EDITOR\" && fileType === \"FINAL\")\r\n    return status === \"EDITING\" || status === \"ASSIGNED\";\r\n\r\n  return false;\r\n}\r\n\r\nexport function canMarkWorkDone(role: UserRole, status: EventStatus) {\r\n  return role === \"CAMERAMAN\" && status === \"CREATED\";\r\n}\r\n\r\nexport function canStartEditing(role: UserRole, status: EventStatus) {\r\n  return role === \"EDITOR\" && status === \"ASSIGNED\";\r\n}\r\n\r\nexport function canMarkCompleted(role: UserRole, status: EventStatus) {\r\n  return role === \"EDITOR\" && status === \"FINAL_UPLOADED\";\r\n}\r\n\r\n\r\n","import type { Event, MediaFile, SessionUser, User } from \"@/lib/types\";\r\nimport type { Notification as UiNotification } from \"@/lib/notifications\";\r\n\r\n// Minimal DB record shapes (keeps typing stable even if tooling can't resolve Prisma model type exports).\r\ntype DbUser = {\r\n  id: string;\r\n  name: string;\r\n  email: string;\r\n  passwordHash: string;\r\n  role: string;\r\n  isFree: boolean;\r\n};\r\n\r\ntype DbEvent = {\r\n  id: string;\r\n  name: string;\r\n  date: Date;\r\n  cameramanId: string;\r\n  editorId: string | null;\r\n  status: string;\r\n  driveRootId: string | null;\r\n  driveRawId: string | null;\r\n  driveEditedId: string | null;\r\n  driveFinalId: string | null;\r\n};\r\n\r\ntype DbFile = {\r\n  id: string;\r\n  eventId: string;\r\n  uploaderId: string;\r\n  fileType: string;\r\n  driveFileId: string | null;\r\n  size: number;\r\n  createdAt: Date;\r\n  name: string;\r\n};\r\n\r\ntype DbNotification = {\r\n  id: string;\r\n  userId: string;\r\n  eventId: string | null;\r\n  title: string;\r\n  message: string;\r\n  type: string | null;\r\n  isRead: boolean;\r\n  createdAt: Date;\r\n};\r\n\r\nexport function mapUser(u: DbUser): User {\r\n  return {\r\n    id: u.id,\r\n    name: u.name,\r\n    email: u.email,\r\n    role: u.role as User[\"role\"],\r\n    isFree: u.role === \"EDITOR\" ? u.isFree : undefined,\r\n  };\r\n}\r\n\r\nexport function mapSessionUser(u: DbUser): SessionUser {\r\n  return { id: u.id, name: u.name, email: u.email, role: u.role as SessionUser[\"role\"] };\r\n}\r\n\r\nexport function mapEvent(e: DbEvent): Event {\r\n  return {\r\n    id: e.id,\r\n    name: e.name,\r\n    date: e.date.toISOString(),\r\n    cameramanId: e.cameramanId ?? null,\r\n    editorId: e.editorId ?? null,\r\n    status: e.status as Event[\"status\"],\r\n    driveFolderId_root: e.driveRootId ?? null,\r\n    driveFolderId_raw: e.driveRawId ?? null,\r\n    driveFolderId_edited: e.driveEditedId ?? null,\r\n    driveFolderId_final: e.driveFinalId ?? null,\r\n  };\r\n}\r\n\r\nexport function mapFile(f: DbFile): MediaFile {\r\n  return {\r\n    id: f.id,\r\n    eventId: f.eventId,\r\n    uploadedBy: f.uploaderId,\r\n    fileType: f.fileType as MediaFile[\"fileType\"],\r\n    driveFileId: f.driveFileId ?? \"\",\r\n    size: f.size,\r\n    timestamp: f.createdAt.toISOString(),\r\n    name: f.name,\r\n  };\r\n}\r\n\r\nexport function mapNotification(n: DbNotification): UiNotification {\r\n  return {\r\n    id: n.id,\r\n    userId: n.userId,\r\n    eventId: n.eventId ?? undefined,\r\n    title: n.title,\r\n    message: n.message,\r\n    isRead: n.isRead,\r\n    type: (n.type ?? \"EVENT_ASSIGNED\") as UiNotification[\"type\"],\r\n    createdAt: n.createdAt.toISOString(),\r\n  };\r\n}\r\n\r\n\r\n"],"names":[],"mappings":"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"}